name: Deploy API to AWS EC2

on:
  workflow_dispatch:
  push:
    branches: ['master']
    paths:
      - 'apps/server/**'
      - '.github/workflows/deploy-server-ec2.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.generate-timestamp.outputs.artifact-name }}
    strategy:
      matrix:
        node-version: [22.x]
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Generate timestamp
        id: generate-timestamp
        run: |
          TIMESTAMP=$(date +'%d-%m-%Y-%H-%M')
          ARTIFACT_NAME="server-build-${TIMESTAMP}"
          echo "artifact-name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          echo "Generated artifact name: ${ARTIFACT_NAME}"

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'yarn'

      - name: Build server
        run: |
          rm -rf ./apps/web
          PRISMA_CLI_BINARY_TARGETS=debian-openssl-3.0.x,rhel-openssl-3.0.x yarn install --frozen-lockfile
          cd apps/server
          touch .env.production
          echo "${{ vars.ENV_FILE }}" > .env.production
          export $(grep -v '^#' .env.production | xargs)
          yarn prisma:generate
          yarn workspace @edusama/common build
          yarn build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.generate-timestamp.outputs.artifact-name }}
          path: |
            **/*
          retention-days: 1

  deploy:
    needs: build
    runs-on: self-hosted
    timeout-minutes: 15
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./${{ needs.build.outputs.artifact-name }}/

      - name: Deploy to server
        run: |
          #  make sure dotenv and dotenv-cli are installed
          npm install -g dotenv dotenv-cli

          # List pm2 processes
          pm2 ls

          # Stop current server
          pm2 stop all || true

          # Delete all current pm2 processes
          pm2 delete all || true

          # show current directory
          pwd

          # move to server
          cd ./${{ needs.build.outputs.artifact-name }}/apps/server

          # create .env.production
          touch .env.production
          echo "${{ vars.ENV_FILE }}" | tr -d '\r' > .env.production

          # Add AWS CloudFront private key from root
          [ -f ~/aws-cf-private-key.pem ] && echo "AWS_CF_PRIVATE_KEY=\"$(cat ~/aws-cf-private-key.pem)\"" >> .env.production && echo "Added AWS CloudFront private key to .env.production" || echo "Warning: aws-cf-private-key.pem not found in home directory"

          export $(grep -v '^#' .env.production | xargs)

          # Start server
          PRISMA_QUERY_ENGINE_LIBRARY=/home/ec2-user/actions-runner/_work/edu/edu/${{ needs.build.outputs.artifact-name }}/node_modules/@prisma/engines/libquery_engine-rhel-openssl-3.0.x.so.node PRISMA_SCHEMA_ENGINE_BINARY=/home/ec2-user/actions-runner/_work/edu/edu/${{ needs.build.outputs.artifact-name }}/node_modules/@prisma/engines/schema-engine-rhel-openssl-3.0.x NODE_ENV=production pm2 start dist/src/server.js

          # Save pm2 processes
          pm2 save

      - name: Clean previous build artifacts except current deployment
        run: |
          echo "Current deployment folder: ${{ needs.build.outputs.artifact-name }}"

          # List all folders in the edusama directory
          echo "Contents of /actions-runner/_work/edu/edu before cleanup:"
          ls -la ~/actions-runner/_work/edu/edu/ || echo "Directory does not exist or is empty"

          # Remove all folders except the current deployment folder
          for folder in ~/actions-runner/_work/edu/edu/*/; do
            if [ -d "$folder" ]; then
              folder_name=$(basename "$folder")
              if [ "$folder_name" != "${{ needs.build.outputs.artifact-name }}" ]; then
                echo "Removing old deployment folder: $folder_name"
                rm -rf "$folder"
              else
                echo "Keeping current deployment folder: $folder_name"
              fi
            fi
          done

          # Also remove any non-directory files in the edusama directory
          for file in ~/actions-runner/_work/edu/edu/*; do
            if [ ! -d "$file" ]; then
              echo "Removing old file: $(basename "$file")"
              rm -f "$file"
            fi
          done

          echo "Contents of /actions-runner/_work/edu/edu after cleanup:"
          ls -la ~/actions-runner/_work/edu/edu/ || echo "Directory does not exist or is empty"
